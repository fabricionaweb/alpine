# Contributor: Fabricio Silva <hi@fabricio.dev>
# Maintainer: Fabricio Silva <hi@fabricio.dev>
pkgname=sonarr-dev
_version=4.0.0.520
pkgver=4.0.0_git20230524
pkgrel=0
pkgdesc="TV download automation for usenet and torrents."
url="https://github.com/Sonarr/Sonarr"
arch="x86_64 aarch64 armv7"
license="GPL-3.0-only"
options="net !check" # no tests
depends="
	aspnetcore6-runtime
	ffmpeg
	sqlite-libs
	"
makedepends="
	dotnet6-sdk
	yarn
	"
subpackages="$pkgname-openrc"
install="$pkgname.pre-install"
source="
	$pkgname-v$pkgver.tar.gz::https://github.com/Sonarr/Sonarr/archive/develop.tar.gz
	0001-disable-restart.patch
	sonarr.initd
	sonarr.confd
	package_info
	"
builddir="$srcdir/Sonarr-develop"
pkgusers="sonarr"
pkggroups="sonarr"

# map arch to dotnet
case $CARCH in
	x86_64) _dotnet_arch="x64" ;;
	aarch64) _dotnet_arch="arm64" ;;
	armv7) _dotnet_arch="arm" ;;
	*) _dotnet_arch="$CARCH" ;;
esac

# custom variables
_runtime="linux-musl-$_dotnet_arch"
_framework="net6.0"
_output="_output"
_artifacts="$_output/$_framework/$_runtime/publish"

prepare() {
	default_prepare

	# increase max opened files
	ulimit -n 4096

	# replace version info
	local buildprops=src/Directory.Build.props
	sed -i -e "s/<AssemblyVersion>[0-9.*]\+<\/AssemblyVersion>/<AssemblyVersion>$_version<\/AssemblyVersion>/g" "$buildprops"
	sed -i -e "s/<AssemblyConfiguration>[\$()A-Za-z-]\+<\/AssemblyConfiguration>/<AssemblyConfiguration>develop<\/AssemblyConfiguration>/g" "$buildprops"
}

build() {
	# build the package
	dotnet build src \
		-p:RuntimeIdentifiers="$_runtime" \
		-p:Configuration=Release \
		-p:SelfContained=false \
		-t:PublishAllRids

	# remove service helpers
	rm -f "$_artifacts"/ServiceUninstall.*
	rm -f "$_artifacts"/ServiceInstall.*
	# remove Sonarr.Windows
	rm -f "$_artifacts"/Sonarr.Windows.*

	# build web ui
	export BROWSERSLIST_IGNORE_OLD_DATA=true
	yarn install --frozen-lockfile --network-timeout 120000
	yarn build --env production --no-stats

	# move web ui to artifacts folder
	mv "$_output"/UI "$_artifacts"
}

package() {
	local DESTDIR="$pkgdir"/usr/lib/sonarr

	# use package_info to disable update feature
	install -Dm644 "$srcdir"/package_info "$DESTDIR"/package_info
	echo "PackageVersion=$pkgver-r$pkgrel" >>"$DESTDIR"/package_info

	cp -af "$_artifacts" "$DESTDIR"/bin
	# use ffprobe from ffmpeg package
	ln -sf /usr/bin/ffprobe "$DESTDIR"/bin
	chown -R "$pkgusers:$pkggroups" "$DESTDIR"

	install -Dm755 "$srcdir"/sonarr.initd "$pkgdir"/etc/init.d/sonarr
	install -Dm644 "$srcdir"/sonarr.confd "$pkgdir"/etc/conf.d/sonarr
}

sha512sums="
174825559ee283460e96d62a2e1bde47a1ce5a6daddfcaf304a25082a130067dc0a56b0d3ba7596a288e1d99091bff6c277fa620c640cb8b4cca04c3402d6c7b  sonarr-dev-v4.0.0_git20230524.tar.gz
6b3f333b9b25630644c2c7aebdb41562e603fe0a761b8fa26e07da6bfa81da8d3ffe86b28c5ab8af92e04da3bf02296f8b02a9c6e573df2b126c0fef69ba6a3e  0001-disable-restart.patch
ffb88eb56814fe229d1964deedc254acd1e3b5070f8d16aa82df63c07b58223fbc62d0f80f1066aa042e075a454829140ad3013388158bce65ebe98364e16dbb  sonarr.initd
b80d663ac4c68756cd709bc1a01aac08b5e6aa97c321dd21d4ced80b2f77810ac7322f8e00f687ab65527fe4beccd31b8fec900d99e55148a31da5dc804b8bad  sonarr.confd
7af490784f86afc563e7d4fcfa1daed84c08310c85d148afbd98befdd7174304a6e2b7c549ddaf7224be1713aef0f9435e6ed5c8ba353ac335131326632d6b55  package_info
"
