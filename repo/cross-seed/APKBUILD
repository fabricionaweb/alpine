# Contributor: Fabricio Silva <hi@fabricio.dev>
# Maintainer: Fabricio Silva <hi@fabricio.dev>
pkgname=cross-seed
pkgver=5.4.0
pkgrel=0
pkgdesc="Fully-automatic cross-seeding with Torznab"
url="https://github.com/cross-seed/cross-seed"
arch="all"
license="Apache-2.0"
options="net !check" # no tests
depends="nodejs"
makedepends="npm python3"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/cross-seed/cross-seed/archive/v$pkgver.tar.gz
	cross-seed.initd
	cross-seed.confd
	"
subpackages="$pkgname-openrc"
install="$pkgname.pre-install"

export HUSKY=0

prepare() {
	default_prepare

	npm ci
}

build() {
	npm run build
	npm prune --omit=dev

	# remove other unnecessary files
	find . -type d -iname '.github' -prune -exec rm -rf {} +;
	find . -type f \( \
			-iname '*.cmd' -o -iname '*.bat' -o \
			-iname '*.map' -o -iname '*.md' -o \
			-iname '*.ts' -o -iname '*.git*' -o \
			-iname 'Makefile' -o -iname 'AUTHORS*' -o \
			-iname 'LICENSE*' -o -iname 'CONTRIBUTING*' -o \
			-iname 'CHANGELOG*' -o -iname 'README*' \
		\) -delete
}

package() {
	local destdir="$pkgdir"/usr/share/node_modules/cross-seed

	install -Dm644 package.json -t $destdir
	cp -af dist node_modules "$destdir"
	install -m755 dist/cmd.js $destdir/dist

	install -dm755 "$pkgdir"/usr/bin
	ln -sf ../share/node_modules/cross-seed/dist/cmd.js "$pkgdir"/usr/bin/cross-seed

	install -Dm755 "$srcdir"/cross-seed.initd "$pkgdir"/etc/init.d/cross-seed
	install -Dm644 "$srcdir"/cross-seed.confd "$pkgdir"/etc/conf.d/cross-seed
}

sha512sums="
8c1756b7fbfac9090267d1ae74df7f1a61c33d4a4c32bbfedc229e2739e7e0fc82a93bb58f37716322dae4075486ac75d46cd7e33f9cabf412208598e8fdd5d8  cross-seed-5.4.0.tar.gz
89896849a0d703b76ee6ba05a8db212aac9c5efeb625c3ee6fc552d3dbb85cbb7e906458ab3e86edb46f855afa62314d56e92725a3721f93397bc9e1c4f10d71  cross-seed.initd
91089033b1b9e768d78471b850af11260d6dcff098880f27b2fe01f33b1deab36afea05e77ab8e76553d5f1dea8d90d53358ae27b5d6bd54f0e7dcf05a4ee8a8  cross-seed.confd
"
